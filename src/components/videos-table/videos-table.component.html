<div class="videos-table-container">
  <div class="table-header">
    <div class="header-content">
      <h3>Selected Video Files ({{ videoFiles().length }})</h3>
      <div class="header-actions">
        @if (conversionService.isConverting()) {
          <button
            mat-raised-button
            color="warn"
            (click)="stopAllConversions()"
            matTooltip="Stop all conversions"
          >
            <mat-icon>stop</mat-icon>
            Stop Conversions
          </button>
        } @else {
          <button
            mat-raised-button
            color="primary"
            [disabled]="
              getSelectedForConversionCount() === 0 ||
              conversionService.isQueueProcessing()
            "
            (click)="startAllSelectedConversions()"
            matTooltip="Start conversion for all selected videos"
          >
            <mat-icon>play_arrow</mat-icon>
            Convert All ({{ getSelectedForConversionCount() }})
          </button>
        }
      </div>
    </div>
  </div>

  @if (videoFiles().length > 0) {
    <div class="table-content">
      <table mat-table [dataSource]="videoFiles()" class="videos-table">
        <!-- File Name -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>File Name</th>
          <td mat-cell *matCellDef="let video">
            <div class="file-info">
              @if (video.movieInfo?.posterPath) {
                <img
                  [src]="getPosterUrl(video.movieInfo.posterPath)"
                  [alt]="video.movieInfo.title"
                  class="movie-poster"
                  (error)="onPosterError($event)"
                />
              } @else {
                <div class="movie-poster no-poster">
                  <mat-icon class="file-icon">video_file</mat-icon>
                </div>
              }
              <span class="file-name">{{ video.name }}</span>
            </div>
          </td>
        </ng-container>

        <!-- File Size -->
        <ng-container matColumnDef="size">
          <th mat-header-cell *matHeaderCellDef>Size</th>
          <td mat-cell *matCellDef="let video">
            <div class="file-size-container">
              <span class="file-size" *ngIf="!video.loading">{{
                formatFileSize(video.size || 0)
              }}</span>
              <div class="loading-indicator" *ngIf="video.loading">
                <mat-progress-spinner
                  mode="indeterminate"
                  diameter="16"
                ></mat-progress-spinner>
                <span>Loading...</span>
              </div>
              <span class="error-text" *ngIf="video.error && !video.loading">{{
                video.error
              }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Movie/Series Title -->
        <ng-container matColumnDef="movieTitle">
          <th mat-header-cell *matHeaderCellDef>Movie/Series Title</th>
          <td mat-cell *matCellDef="let video">
            <div class="movie-info">
              @if (video.movieInfoLoading) {
                <div class="loading-indicator">
                  <mat-progress-spinner
                    mode="indeterminate"
                    diameter="16"
                  ></mat-progress-spinner>
                  <span>Searching...</span>
                </div>
              } @else if (video.movieInfo) {
                <div class="movie-details">
                  <div class="movie-title flex items-center gap-2">
                    <mat-icon class="movie-icon">
                      {{ video.movieInfo.type === "tv" ? "tv" : "movie" }}
                    </mat-icon>
                    <span class="title">{{ video.movieInfo.title }}</span>
                    @if (video.movieInfo.year) {
                      <span class="year">({{ video.movieInfo.year }})</span>
                    }
                  </div>
                  @if (video.movieInfo.confidence < 0.7) {
                    <div class="confidence-warning">
                      <mat-icon>warning</mat-icon>
                      <span>Low confidence</span>
                    </div>
                  }
                </div>
              } @else {
                <span class="no-info">No information</span>
              }
            </div>
          </td>
        </ng-container>

        <!-- Conversion Status -->
        <ng-container matColumnDef="conversion">
          <th mat-header-cell *matHeaderCellDef>Conversion</th>
          <td mat-cell *matCellDef="let video">
            <div class="conversion-container">
              <div class="conversion-pending">
                <mat-checkbox
                  [checked]="isVideoSelectedForConversion(video.path)"
                  (change)="
                    toggleConversionSelection(video.path, $event.checked)
                  "
                >
                </mat-checkbox>
                @if (
                  getConversionStatus(video.path) === "none" ||
                  getConversionStatus(video.path) === "pending" ||
                  getConversionStatus(video.path) === "cancelled"
                ) {
                  <button
                    mat-icon-button
                    color="primary"
                    matTooltip="Start conversion"
                    (click)="startConversion($event, video)"
                    [disabled]="!isVideoSelectedForConversion(video.path)"
                  >
                    <mat-icon>play_arrow</mat-icon>
                  </button>
                } @else if (getConversionStatus(video.path) === "converting") {
                  <div class="conversion-progress">
                    <mat-progress-bar
                      [value]="getConversionProgress(video.path)"
                      mode="determinate"
                    ></mat-progress-bar>
                    <span class="progress-text">{{
                      getConversionProgressText(video.path)
                    }}</span>
                  </div>
                } @else if (getConversionStatus(video.path) === "completed") {
                  <div class="conversion-completed">
                    <mat-icon color="success">check_circle</mat-icon>
                    <span>Completed</span>
                  </div>
                } @else if (getConversionStatus(video.path) === "error") {
                  <div class="conversion-error">
                    <mat-icon color="warn">error</mat-icon>
                    <span>Error</span>
                  </div>
                } @else if (getConversionStatus(video.path) === "cancelled") {
                  <div class="conversion-cancelled">
                    <mat-icon color="warn">cancel</mat-icon>
                    <span>Cancelled</span>
                  </div>
                }
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let video">
            <div class="actions-container">
              <button
                mat-icon-button
                color="primary"
                matTooltip="View optimization details"
                (click)="onVideoClick(video)"
              >
                <mat-icon>info</mat-icon>
              </button>
              @if (
                video.movieAlternatives &&
                video.movieAlternatives.alternatives.length > 1
              ) {
                <button
                  mat-icon-button
                  color="accent"
                  matTooltip="Choose another movie/series"
                  (click)="onOpenMovieAlternatives(video, $event)"
                >
                  <mat-icon>movie</mat-icon>
                </button>
              }
              @if (video.movieInfo && video.movieInfo.confidence < 0.7) {
                <button
                  mat-icon-button
                  color="warn"
                  matTooltip="Manual search"
                  (click)="onManualSearch(video, $event)"
                >
                  <mat-icon>search</mat-icon>
                </button>
              }
              @if (getConversionStatus(video.path) === "converting") {
                <button
                  mat-icon-button
                  color="warn"
                  matTooltip="Stop conversion"
                  (click)="stopConversion($event)"
                >
                  <mat-icon>stop</mat-icon>
                </button>
              }
              @if (getConversionStatus(video.path) === "completed") {
                <button
                  mat-icon-button
                  color="primary"
                  matTooltip="Open converted file"
                  (click)="openConvertedFile(video.path, $event)"
                >
                  <mat-icon>play_circle</mat-icon>
                </button>
              }
              @if (getConversionStatus(video.path) === "cancelled") {
                <button
                  mat-icon-button
                  color="primary"
                  matTooltip="Restart conversion"
                  (click)="startConversion($event, video)"
                >
                  <mat-icon>refresh</mat-icon>
                </button>
              }
              <button
                mat-icon-button
                color="warn"
                matTooltip="Remove from list"
                (click)="onVideoRemove(video, $event)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns()"
          class="video-row"
          (click)="onVideoClick(row)"
        ></tr>
      </table>
    </div>
  } @else {
    <ng-template>
      <div class="no-files">
        <mat-icon class="no-files-icon">video_library</mat-icon>
        <p>No video files selected</p>
        <p class="subtitle">Select video files to start optimization</p>
      </div>
    </ng-template>
  }
</div>
